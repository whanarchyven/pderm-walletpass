# GPT Context
Моя задача написать cli - сервис на typescript.
Он будет лежать внутри уже сконфигурированного NextJS в папке ./services/deploy но не будет относится к самому NextJS
Он должен будет уметь работать с корневой папкой того же самого проекта где и лежит.
Его надо будет иметь возможность вызывать как из под корневого каталога так и из подкаталога, 
место запуска будет определять существенный контекст выполнения.
Помоги написать бойлерпейт для этого сервиса и организовать папки внутри.
И выбрать стек пакетов, которые мне могли бы помочь.
Потребуется исполнение баш-скриптов, использование rsync, подключение по ssh через файл-ключ,
исполнение скриптов на удаленной машине, возможность дождаться какой-то части оттуда.

Ниже я привожу неполную логику сервиса, чтобы ты лучше понял функционал:


## Алгоритм экспорта и деплоя

- Проверка на наличие папки .build для определения корректности дальнейшей работы
- Копирование всего кроме (.next, .build, node_modules, pages) в новую папку внутри .build/next/
- Добавление в новую папку симлинка на родительские node_modules
- Копирование папки pages, относящейся к контексту в корень
- Очистка неиспользуемого ts кода c помощью ts-prune
- Удаление пустых файлов и папок
- Чистка package.json на предмет лишних зависимостей
- Очистка лишних скриптов
- Добавление типового шаблона в pages/api/build-info.ts со сведениями о дате и времени сборки

Далее, параллельно:
- Параллель 1
  - отправка на удаленный сервер обновленного package.json для чистой инсталляции или обновления прямо на рабочем инстансе
  - запуск yarn install на удаленной машине для обновления внешних зависимостей

- Параллель 2
  - Запуск yarn build на локальной машине
  - Отправка содержимого public

После завершения обоих процессов (на удаленной машине):
  - Остановка соответствующего инстанса через pm2
  - Резервное копирование старого билда
  - Отправка артефактов (.next кроме .next/cache, next.config.js) через rsync с локальной машины на удаленную
  - Запуск соответствующего инстанса через pm2



